---
title: "Proyecto MNO"
author: "Equipo 3: Delia Del Águila, Eddie Lozada, Marissa Martinez"
date: "Mayo 2019"
output: html_document
---

#Análisis de Datos

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(DataExplorer)
library(ggplot2)
library(dplyr) 
library(ISLR) 
library(proto)
library(RSQLite)
library(gsubfn)
library(sqldf)
library(data.table)
#install.packages("TraMineR")
library(TraMineR)
library(RColorBrewer)
library(readr)
```

## Análisis Exploratorio de los Datos.

```{r}
setwd("~/no_cloud/Analisis Numerico 2019/Proyecto Final")
df=read_csv("control.csv")
```

Se cuenta con una base de datos con 203 196 registros, que corresponde al registro de calificaciones de alumnos en primaria y secundaria a lo largo de 7 ciclos escolares consecutivos. Se tienen 65 variables.

* n_registro=variable identificadora del registro
* sexo=sexo (masculino,femenino)
* nciclo1=nivel registrado en el ciclo 1 (primaria, secundaria)
* grado_c1=grado escolar registrado en el ciclo1
* cesp_c1=calificación en español en el ciclo1
* cMAT_c1=calificación en matemáticas en el ciclo1
* cCNAT_c1=calificación en ciencias naturales en el ciclo1
* cCIE_c1=calificación en ciencias en el ciclo1
* cSOC_c1=calificación en ciencias sociales en el ciclo1
* cFCYE_c1=calificación en formación civica y ética en el ciclo1
* fc_c1=calificación final del grado en el ciclo 1.

Estos datos se repiten para cada ciclo y el ciclo se identifica por el número en que termina el nombre de la variable.
```{r,echo=FALSE}
head(df,2)
```

Primero se verifica que no existan datos duplicados

```{r cars}
nrow(df[duplicated(df), ])
```
Observaremos , una gran cantidad de NA's, sin embargo la explicación de este dato radica en que no en todos los ciclos escolares el alumno está registrado, ya sea porque terminó sus estudios o los interrumpió, a la vez para cada nivel se imparten materias diferentes, siendo en común para ambos niveles solo Español y Matemáticas, en primaria se imparte exclusivamente Ciencias Naturales y Formación Civica y Ética, mientras que en secundaria se tienen registros de Ciencias Sociales y Ciencias Exactas, esta última se refiere a Fisica y Quimica, por lo tanto alumnos inscritos en primaria tendran NA en las variables que se refieran a ciencias sociales y ciencias exactas, de forma análoga aquellos inscritos en secundaria tendran NA en las variables de formación civica y ética y ciencias naturales.
```{r}
glimpse(df)
```

**Variable sexo**
Se verifica que la variable sexo no tenga dato faltante.

```{r}
summary(df$sexo)
```

**Variable nivel**
Verificamos que en la variable que corresponde a nivel para cada ciclo, solo se contemple a primaria y secundaria

```{r}
vars_nivel<-c("nciclo1","nciclo2","nciclo3","nciclo4","nciclo5","nciclo6","nciclo7")
summary(df[vars_nivel])
```
Observamos que hay campos en blanco, por lo que procedemos a convertirlos en NA, para mayor claridad en la base
```{r,echo=FALSE}
df$nciclo2[df$nciclo2==""]<-NA
df$nciclo3[df$nciclo3==""]<-NA
df$nciclo4[df$nciclo4==""]<-NA
df$nciclo5[df$nciclo5==""]<-NA
df$nciclo6[df$nciclo6==""]<-NA
df$nciclo7[df$nciclo7==""]<-NA

summary(df[vars_nivel])
           
```

**Variable grado escolar**
Se valida que el rango de grados en primaria sea de 1° a 6° grado en primaria y 1° a 3° en secundaria para los 7 ciclos escolares

```{r,echo=FALSE}
table (df$nciclo1,df$grado_c1)
table (df$nciclo2,df$grado_c2)
table (df$nciclo3,df$grado_c3)
table (df$nciclo4,df$grado_c4)
table (df$nciclo5,df$grado_c5)
table (df$nciclo6,df$grado_c6)
table (df$nciclo7,df$grado_c7)
```
Se valida que el rango de calificaciones sea consistente.
**Calificaciones por materia**

```{r}
vars_cal<-c("cesp_c1", "cesp_c2", "cesp_c3", "cesp_c4", "cesp_c5", "cesp_c6", "cesp_c7","cMAT_c1", "cMAT_c2", "cMAT_c3", "cMAT_c4", "cMAT_c5", "cMAT_c6", "cMAT_c7","cSOC_c1", "cSOC_c2", "cSOC_c3", "cSOC_c4", "cSOC_c5", "cSOC_c6", "cSOC_c7","cCIE_c1", "cCIE_c2", "cCIE_c3", "cCIE_c4", "cCIE_c5", "cCIE_c6", "cCIE_c7","cFCYE_c1", "cFCYE_c2", "cFCYE_c3", "cFCYE_c4", "cFCYE_c5", "cFCYE_c6", "cFCYE_c7","cCNAT_c1", "cCNAT_c2", "cCNAT_c3", "cCNAT_c4", "cCNAT_c5", "cCNAT_c6", "cCNAT_c7")

summary(df[vars_cal])
```

**Calificaciones finales**
```{r}
vars_cf<-c("cf_c1","cf_c2","cf_c3","cf_c4","cf_c5","cf_c6","cf_c7")
summary(df[vars_cf])
```


```{r}

boxplot(df$cesp_c5, df$cMAT_c5,df$cCIE_c5,df$cSOC_c5,df$cCNAT_c5,df$cFCYE_c5,
main = "Distribución de calificaciones ciclo 5",
#at = c(1,2,4,6,8,10),
names = c("Español", "Matemáticas", "Ciencias","Sociales", "Cie. Nat","FCyE"),
col = c("darkturquoise","lightsteelblue3","khaki","pink","cyan4","brown2","purple"),
border = "ivory4",
horizontal = F
)

```

Observamos la relación entre calificaciones de matemáticas y españolcon respecto a la calificación final de grado desagregando por nivel escolar. (ciclo 1)

* Español
```{r}
ggplot(df, aes(x = cesp_c1, y = cf_c1)) + 
  geom_jitter() +
  facet_wrap(~ nciclo1)
```
```{r}

```

Se nota que existen calificaciones con **0** y una calificación final alta, por lo que se tiene que revisar estos registros ya que sugieren que hay registros con calificaciones finales pero sin calificaciones en las materias.


*Matemáticas

```{r}
ggplot(df, aes(x = cMAT_c1, y = cf_c1)) + 
  geom_jitter() +
  facet_wrap(~ nciclo1)
```
Posteriormente observa la relación que existe entre calificaciones en español y matemáticas con respecto a la calificación final del grado. En donde se comprueba la relación entre calificaciones altas conducen a calificaciónes de grado aprobatorias.

```{r}
ggplot(df, aes(x = cesp_c1, y = cf_c1)) + 
  geom_jitter() +
  facet_wrap(~ cMAT_c1)
```

Se observa que en ambos sexos, la distribución de las calificaciones de matemáticas con respecto a la calificación final, es bastante similar. 

```{r}
ggplot(df, aes(x = cMAT_c1, y = cf_c1)) + 
  geom_point() +
  facet_wrap(~ sexo)
```



**¿Qué tiempo le toma a un alumno terminar la primaria/secundaria?**

Parra este análisis, resulta conveniente seguir un orden consecutivo en los grados escolares en la transición de primaria a secundaria, es decir despues de cursar los 6 grados de primaria, usaremos como notación para los 7,8,9 para indicar 1ro, 2do y 3ro de secundaria respectivamente.
```{r,echo=FALSE}

df$grado_c1[df$nciclo1=="SECUNDARIA"&df$grado_c1==1]<-7
df$grado_c2[df$nciclo2=="SECUNDARIA"&df$grado_c2==1]<-7
df$grado_c3[df$nciclo3=="SECUNDARIA"&df$grado_c3==1]<-7
df$grado_c4[df$nciclo4=="SECUNDARIA"&df$grado_c4==1]<-7
df$grado_c5[df$nciclo5=="SECUNDARIA"&df$grado_c5==1]<-7
df$grado_c6[df$nciclo6=="SECUNDARIA"&df$grado_c6==1]<-7
df$grado_c7[df$nciclo7=="SECUNDARIA"&df$grado_c7==1]<-7

df$grado_c1[df$nciclo1=="SECUNDARIA"&df$grado_c1==2]<-8
df$grado_c2[df$nciclo2=="SECUNDARIA"&df$grado_c2==2]<-8
df$grado_c3[df$nciclo3=="SECUNDARIA"&df$grado_c3==2]<-8
df$grado_c4[df$nciclo4=="SECUNDARIA"&df$grado_c4==2]<-8
df$grado_c5[df$nciclo5=="SECUNDARIA"&df$grado_c5==2]<-8
df$grado_c6[df$nciclo6=="SECUNDARIA"&df$grado_c6==2]<-8
df$grado_c7[df$nciclo7=="SECUNDARIA"&df$grado_c7==2]<-8


df$grado_c1[df$nciclo1=="SECUNDARIA"&df$grado_c1==3]<-9
df$grado_c2[df$nciclo2=="SECUNDARIA"&df$grado_c2==3]<-9
df$grado_c3[df$nciclo3=="SECUNDARIA"&df$grado_c3==3]<-9
df$grado_c4[df$nciclo4=="SECUNDARIA"&df$grado_c4==3]<-9
df$grado_c5[df$nciclo5=="SECUNDARIA"&df$grado_c5==3]<-9
df$grado_c6[df$nciclo6=="SECUNDARIA"&df$grado_c6==3]<-9
df$grado_c7[df$nciclo7=="SECUNDARIA"&df$grado_c7==3]<-9

table (df$nciclo1,df$grado_c1)
table (df$nciclo2,df$grado_c2)
table (df$nciclo3,df$grado_c3)
table (df$nciclo4,df$grado_c4)
table (df$nciclo5,df$grado_c5)
table (df$nciclo6,df$grado_c6)
table (df$nciclo7,df$grado_c7)
```

observamos la consistencia en el avance escolar de un ciclo a otro.
```{r,echo=FALSE}

grados1<-sqldf('SELECT sexo,grado_c1,grado_c2,grado_c3,grado_c4,grado_c5,grado_c6,grado_c7 FROM df where grado_c1==1 GROUP BY 1,2,3,4,5,6,7 ')

stripchart(grados1[,2:8],vertical=T,pch=10,ylab="Grado",group.names=c("ciclo1","ciclo2","ciclo3","ciclo4","ciclo5","ciclo6","ciclo7"),col=c("orange","red","pink","blue","green","black","purple"))

```



En la gráfica, podemos observbar que existen registros que en el ciclo 1 cuando comenzaron 1er grado, para  el ciclo 2, se encuentran en 3° y 4° por lo cual son errores de registro. Por lo cual se limpia la base de estas observaciones anómalas, por lo que en la segunda gráfica se puede observar coherencia en el avance de los grados de un ciclo a otro.

```{r,echo=FALSE}
#i<-subset(df,grado_c1==6 & grado_c2<6)

df$eliminar<-0
df$eliminar[which(df$grado_c1==1 & df$grado_c2>2)]<-1
df$eliminar[which(df$grado_c1==3 & df$grado_c2>5)]<-1
df$eliminar[which(df$grado_c1==6 & df$grado_c2<6)]<-1

df$eliminar[which(df$grado_c2==2 & df$grado_c3>3)]<-1
df$eliminar[which(df$grado_c2==3 & df$grado_c3>4)]<-1
df$eliminar[which(df$grado_c2==4 & df$grado_c3>5)]<-1

df$eliminar[which(df$grado_c2 %in% c(NA,2) & df$grado_c4>4)]<-1




df$eliminar[which(df$grado_c3==2 & df$grado_c4>3)]<-1
df$eliminar[which(df$grado_c3==4 & df$grado_c4>5)]<-1

df$eliminar[which(df$grado_c4==2 & df$grado_c5>3)]<-1
df$eliminar[which(df$grado_c4==4 & df$grado_c5>5)]<-1

df$eliminar[which(df$grado_c5==4 & df$grado_c6>5)]<-1

df$eliminar[which(df$grado_c6==4 & df$grado_c7>5)]<-1
df$eliminar[which(df$grado_c1==6 & df$grado_c2==2)]<-1


df_new<-df[df$eliminar==0,]

#write.csv(df_new, "./df_limpio.csv", sep=",")

#comprobación de consistecia en los datos

grados1<-sqldf('SELECT sexo,grado_c1,grado_c2,grado_c3,grado_c4,grado_c5,grado_c6,grado_c7,count(*) as conteo FROM df_new where grado_c1=1 GROUP BY 1,2,3,4,5,6,7 ')

stripchart(grados1[,2:8],vertical=T,pch=10,ylab="Grado",group.names=c("ciclo1","ciclo2","ciclo3","ciclo4","ciclo5","ciclo6","ciclo7"),col=c("orange","red","pink","blue","green","black","purple"))


```



En la siguiente gráfica observamos como se da el avance escolar durante la ventana de tiempo observada, así para un conjunto de alumnos que iniciaron 1er grado de primaria en el ciclo 1, podemos observar la variedad de casos posibles que se dieron durante estos ciclos escolares, notamos que hubo un alto porcentaje de niños que lograron terminar su educación primaria y acceder al primer grado de secundaria, por el contrario tambien se puede notar que algunos solo terminaron la primaria y no continuaron la secundaria.
```{r,,echo=FALSE}
#seleccionamos una generación de estudiantes que inician 1er gardo de primaria en ciclo1
grados<-sqldf('SELECT grado_c1,grado_c2,grado_c3,grado_c4,grado_c5,grado_c6,grado_c7 FROM df_new where grado_c1=1')

grados_labels <- c("1°Primaria", "2°Primaria", "3°Primaria", "4°Primaria", "5°Primaria", "6°Primaria", "1°Secundaria")
grados_states <- c("1", "2", "3", "4", "5", "6", "7")
avance <- seqdef(grados, var=1:7, states= grados_states, labels=grados_labels, right=NA, left=NA, missing=NA)
seqfplot(avance,border=NA,with.legend='right', cex.legend=1,cpal=brewer.pal(7,"YlGnBu"),main="Transición entre grados escolares")

```

```{r,echo=FALSE}

#seleccionamos una generación de estudiantes que inician 1er gardo de secundaria en ciclo2
grados_sec<-sqldf('SELECT grado_c2,grado_c3,grado_c4,grado_c5,grado_c6,grado_c7 FROM df_new where grado_c2=7')

grados_labels1 <- c( "1°Secundaria","2°Secundaria", "3°Secundaria")
grados_states1 <- c(  "7","8","9")
avance_sec <- seqdef(grados_sec, var=1:6, states= grados_states1, labels=grados_labels1, right=NA, left=NA, missing=NA)

seqfplot(avance_sec,border=NA,with.legend='right', cex.legend=1,cpal=brewer.pal(3,"YlGnBu"),main="Transición entre grados escolares")
```


En está gráfica notamos como a algunos alumnos que iniciaron secundaria en el ciclo 2, les tomo más de 3 años terminar la secundaria.

```{r}
#seleccionamos una generación de estudiantes que inician 3er grado de primaria en ciclo1
grados_ter<-sqldf('SELECT grado_c1,grado_c2,grado_c3,grado_c4,grado_c5,grado_c6,grado_c7 FROM df_new where grado_c1=3')

grados_labels2 <- c("3°P", "4°P", "5°P", "6°P", "1°S","2°S","3°S")
grados_states2 <- c(  "3","4","5","6","7","8","9")
avance_ter <- seqdef(grados_ter, var=1:7, states= grados_states2, labels=grados_labels2, right=NA, left=NA, missing=NA)

seqfplot(avance_ter,border=NA,with.legend='right', cex.legend=1.2,cpal=brewer.pal(7,"YlOrRd"),main="Transición entre grados escolares")
```

#Ejecución lm

Para hecer más sencilla la ejecución del modelo transformaremos los datos manteniendo las siguientes variables:

- n_registro: Número de registro
- masculino: Si el alumno es niño está varible será 1, si es niña el valor será 0
- g1: El grado con el que inicio en el la ventana de estudio, el mínimo será 9 bajo la hipótesis que todos los alumnos que en el primer ciclo cursan un grado distinto al primero de primaria habrán cursado anteriormente los niveles inferiores de una manera normal
- tiempo: El tiempo en años que el alumno tardó en concluir sus estudios de educación básica
- no_censura: Si la varible es 1 señala que el dato NO está censurado, si es 0 es un dato con censura
- exito: Si el alumno concluyó sus estudios en 9 años su valor será 1, de lo contrario 0
- esp1: La calificación del grado 1 en español
- mat1: La calificación de matemáticas en matemáticas
- cie1: Para primaria indicará la calificación de Ciencia Naturales y para secundaria la calificación de Ciencias
- soc1: Para primaria indicará la calificación de Cívica y Ética, para secundaria indicará la calificación de Sociales

```{r}
library(sqldf)

dft <- sqldf("
  select 
    n_registro, masculino, g1, 
    t1 + t2 + t3 + t4 + t5 + t6 + t7 + t_aux as tiempo, no_censura, censura,
    case when ((t1 + t2 + t3 + t4 + t5 + t6 + t7 + t_aux) = 9 
      and (g1=9 or g2=9 or g3=9 or g4=9 or g5=9 or g6=9 or g7=9)) then(1) else 0 end as exito,
    esp1, mat1, cie1, soc1,
    esp2, mat2, cie2, soc2,
    esp3, mat3, cie3, soc3,
    esp4, mat4, cie4, soc4,
    esp5, mat5, cie5, soc5,
    esp6, mat6, cie6, soc6,
    esp7, mat7, cie7, soc7
  from
    (select *, 1 as t1,
      case when grado_c2 is null and (g3 is not null or g4 is not null or g5 is not null or g6 is not null or g7 is not null) then(1) 
        when grado_c2 is not null then(1) else 0 end as t2,
      case when grado_c3 is null and (g4 is not null or g5 is not null or g6 is not null or g7 is not null) then(1) 
        when grado_c3 is not null then(1) else 0 end as t3,
      case when grado_c4 is null and (g5 is not null or g6 is not null or g7 is not null) then(1) 
        when grado_c4 is not null then(1) else 0 end as t4,
      case when grado_c5 is null and (g6 is not null or g7 is not null) then(1) 
        when grado_c5 is not null then(1) else 0 end as t5,
      case when grado_c6 is null and (g7 is not null) then(1) 
        when grado_c6 is not null then(1) else 0 end as t6,
      case when grado_c7 is null and (g1!=9 and g2!=9 and g3!=9 and g4!=9 and g5!=9 and g6!=9) then(1) 
        when grado_c7 is not null then(1) else 0 end as t7,
      g1-1 as t_aux,
      case when g1!=9 and (g2!=9 or g2 is null) and (g3!=9 or g3 is null) and (g4!=9 or g4 is null) 
        and (g5!=9 or g5 is null) and (g6!=9 or g6 is null) and (g7!=9 or g7 is null) then (0) else 1 end as no_censura,
      case when g1!=9 and (g2!=9 or g2 is null) and (g3!=9 or g3 is null) and (g4!=9 or g4 is null) 
        and (g5!=9 or g5 is null) and (g6!=9 or g6 is null) and (g7!=9 or g7 is null) then (1) else 0 end as censura
    from
      (select *,
      case when sexo='H' then (1) else 0 end as masculino, 
      grado_c1 as g1, grado_c2 as g2, grado_c3 as g3, grado_c4 as g4, grado_c5 as g5, grado_c6 as g6, grado_c7 as g7,
      
      cesp_c1 as esp1, cesp_c2 as esp2, cesp_c3 as esp3, cesp_c4 as esp4, cesp_c5 as esp5, cesp_c6 as esp6, cesp_c7 as esp7,
      cMAT_c1 as mat1, cMAT_c2 as mat2, cMAT_c3 as mat3, cMAT_c4 as mat4, cMAT_c5 as mat5, cMAT_c6 as mat6, cMAT_c7 as mat7,
      case when nciclo1='SECUNDARIA' then(cCIE_c1) else cCNAT_c1 end as cie1,
      case when nciclo1='SECUNDARIA' then(cCIE_c2) else cCNAT_c1 end as cie2,
      case when nciclo1='SECUNDARIA' then(cCIE_c3) else cCNAT_c1 end as cie3,
      case when nciclo1='SECUNDARIA' then(cCIE_c4) else cCNAT_c1 end as cie4,
      case when nciclo1='SECUNDARIA' then(cCIE_c5) else cCNAT_c1 end as cie5,
      case when nciclo1='SECUNDARIA' then(cCIE_c6) else cCNAT_c1 end as cie6,
      case when nciclo1='SECUNDARIA' then(cCIE_c7) else cCNAT_c1 end as cie7,
      case when nciclo1='SECUNDARIA' then(cSOC_c1) else cFCYE_c1 end as soc1,
      case when nciclo1='SECUNDARIA' then(cSOC_c2) else cFCYE_c1 end as soc2,
      case when nciclo1='SECUNDARIA' then(cSOC_c3) else cFCYE_c1 end as soc3,
      case when nciclo1='SECUNDARIA' then(cSOC_c4) else cFCYE_c1 end as soc4,
      case when nciclo1='SECUNDARIA' then(cSOC_c5) else cFCYE_c1 end as soc5,
      case when nciclo1='SECUNDARIA' then(cSOC_c6) else cFCYE_c1 end as soc6,
      case when nciclo1='SECUNDARIA' then(cSOC_c7) else cFCYE_c1 end as soc7
      from df))
  ")
```

```{r}
library(dplyr)


```


Nuestra base cuenta con 39% de los datos con censura

```{r}
sqldf("select distinct no_censura, count(*)
      from dft
      group by no_censura")
```

Veamos que como es esperado la mayor cantidad de los alumnos tardan 9 años en concluir educación básica

```{r}
library(ggplot2)

dft %>% 
  count(tiempo) %>% 
  group_by(tiempo) %>%  
  ggplot(aes(as.factor(tiempo))) + 
      geom_bar(aes(weight=n),  fill="#003f5c") +
    xlab("Tiempo en concluir la educación básica (años)") + ylab("Frecuencia")

```

En general el 61% de los alumnos concluyeron su educación básica.

Cuando no hay censura el 97% de los alumnos concluyeron en 9 años su educación básica.

```{r}
sqldf("select distinct exito, count(*)
      from dft
      where censura=1
      group by exito")

View(sqldf("select n_registro,g1, esp1, esp2, esp3, esp4, esp5, esp6, esp7
      from dft
      where censura=1"))

sqldf("select grado_c1,grado_c2,grado_c3,grado_c4,grado_c5,grado_c6,grado_c7
      from df
      where n_registro=848195")

```
  

```{r}
dtp <- dft %>% 
  mutate( esp=rowMeans(dft %>% select(esp1, esp2, esp3, esp4, esp5, esp6, esp7), na.rm = TRUE)) %>%
  mutate( mat=rowMeans(dft %>% select(mat1, mat2, mat3, mat4, mat5, mat6, mat7), na.rm = TRUE)) %>%
  mutate( cie=rowMeans(dft %>% select(cie1, cie2, cie3, cie4, cie5, cie6, cie7), na.rm = TRUE)) %>%
  mutate( soc=rowMeans(dft %>% select(soc1, soc2, soc3, soc4, soc5, soc6, soc7), na.rm = TRUE)) %>%
  mutate( log_tiempo=log(tiempo)) %>%
  select(n_registro, tiempo, exito, log_tiempo, masculino, no_censura, censura, esp, mat, cie, soc) %>%
  arrange(log_tiempo)

```


```{r}
# https://github.com/Homebrew/legacy-homebrew/issues/43290
install.packages("imputeYn")

library(remotes)
install_version("quadprog", "1.5-5")

library(imputeYn)
library(quadprog)

dfpr <- dtp[sample(nrow(dtp), 499), ] %>% arrange(log_tiempo)
new_c <- c(1105964, 11, 0, 2.397895, 0, 0,1, 7.000000, 6.750000, 7.000000, 7.000000)
dfpr <- rbind(dfpr, new_c) %>% arrange(log_tiempo)

imputeYn(as.matrix(dfpr %>% select(esp, mat, cie, soc)), dfpr$log_tiempo, dfpr$no_censura, method = "condMean", beta=NULL)

```


```{r}
dtp$tiempo[dtp$censura==1]<-11

dtp %>% 
  count(tiempo) %>% 
  group_by(tiempo) %>%  
  ggplot(aes(as.factor(tiempo))) + 
      geom_bar(aes(weight=n),  fill="#003f5c") +
    xlab("Tiempo en concluir la educación básica (años)") + ylab("Frecuencia")

```


```{r}

View(dtp)

write.csv(dtp,"data.csv")
 reg <- lm(dtp$tiempo ~ dtp$masculino + dtp$esp + dtp$mat + dtp$cie + dtp$soc)

summary(reg)

```

#Ejecución de métodos programados

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Ejecución de los comandos SVD y QR  para problema de regresión.

Utilizamos la base de datos obtenida en "Avance3"

```{r}
library(Matrix)
dtp=read.csv('./data.csv', header=T)
```
Recordamos los resultados obtenidos de lm
```{r}
reg <- lm(dtp$tiempo ~ dtp$masculino + dtp$final + dtp$esp1 + dtp$mat1)
summary(reg)
```
De la documentación de R, sabemos que la función lm, realiza por default la descomposición qr.


lm(formula, data, subset, weights, na.action,
   method = **"qr"**, model = TRUE, x = FALSE, y = FALSE, qr = TRUE,
   singular.ok = TRUE, contrasts = NULL, offset, ...)


En este ejercicio vamos a obtener los coeficientes con las funciones de "qr" ya establecidas en R

##QR
```{r}
mf<-model.frame(dtp$tiempo ~ dtp$masculino + dtp$esp + dtp$mat + dtp$cie + dtp$soc)
mdesign<-model.matrix(reg) #matriz de diseño
response<-model.extract(mf,"response")#variable respuesta
A<-qr(mdesign)
qr.coef(A,response)
```


##SVD

```{r}
# Creamos un data frame con todas las variables involucradas en la regresión.
data_ = data.frame(masculino = dtp$masculino, final = dtp$final, esp1 = dtp$esp1, mat1 = dtp$mat1, tiempo = dtp$tiempo)
# Quitamos nulos.
data_ = data_[complete.cases(data_),]
# Creamos la matriz de diseño.
data_model <- model.matrix(~ data_$masculino + data_$final + data_$esp1 + data_$mat1)
SVD = svd(data_model)

# y_ será nuestra variable dependiente.
y_ = as.matrix(data_$tiempo)
V = SVD$v
U = SVD$u
D = SVD$d

# Calculamos los pesos.
weights = as.numeric(V %*% (crossprod(U, y_) / D))
weights
```

##CVXR
```{r}
library(CVXR)
# Creamos un data frame con todas las variables involucradas en la regresión.
data_ = data.frame(masculino = dtp$masculino, final = dtp$final, esp1 = dtp$esp1, mat1 = dtp$mat1, tiempo = dtp$tiempo)
# Quitamos nulos.
data_ = data_[complete.cases(data_),]
# Creamos la matriz de diseño.
data_model <- model.matrix(~ data_$masculino + data_$final + data_$esp1 + data_$mat1)

# y_ será nuestra variable dependiente.
y_ = data_$tiempo

n = 5 # Número de variables independientes.
beta = Variable(n)
obj = sum_squares(y_ - data_model %*% beta)
prob = Problem(Minimize(obj))
result = solve(prob, solver="SCS")
weights = t(result$getValue(beta))
weights
```

##QR con reflectores de Householder
```{r}
hh_qr = function (A, complete = FALSE) {
  m = nrow(A) # Número de filas
  n = ncol(A) # Número de columnas
  c = n # Tomamos n porque tenemos menos columnas que filas
  H_ = list() # Lista en la que almacenamos las H's resultantes
  R_ = A # Inicializamos R_ con la matriz de entrada
  
  for (i in 1:c) {
    # Tomamos la columna correspondiente a la iteración
    x = R_[i:m, i] 
    # Creamos la matriz de dimensión [m,n] [1,0,...0]
    e = as.matrix(c(1, rep(0, length(x)-1)))
    # Encontramos la reflexión de la columna correspondiente
    vi = x + sign(x[1]) * sqrt(sum(x^2)) * e

    # Calculamos H = I - 2*vi*t(vi)
    I_ = diag(length(x)) # Matriz identidad
    hi =  I_ - 2 * as.vector(tcrossprod(x = vi, y = vi)) / as.vector(crossprod(x = vi, y = vi))

    if (i > 1) {
      # Calculamos H * A
      # Aquí se hacen ceros los valores de las columnas (excepto la columna inicial)
      hi = bdiag(diag(i-1), hi)
    }
     
    H_[[i]] = hi # Almacenamos la Hi parcial
    R_ = hi %*% R_ # Calculamos la nueva R
  }
 
  # Calculamos Q a partir de la multiplicación de las H's parciales
  Q_ = Reduce("%*%", H_)
  return (list('Q' = Q_, 'R' = R_))
}

# Creamos un data frame con todas las variables involucradas en la regresión.
data_ = data.frame(masculino = dtp$masculino, final = dtp$final, esp1 = dtp$esp1, mat1 = dtp$mat1, tiempo = dtp$tiempo)
# Quitamos nulos.
data_ = data_[complete.cases(data_),]
# Creamos la matriz de diseño.
data_model <- model.matrix(~ data_$masculino + data_$final + data_$esp1 + data_$mat1)
qr_ = hh_qr(data_model)

y_ = data_$tiempo

weights = solve(qr_$R[1:5,]) %*% t(qr_$Q[,1:5]) %*% y_
weights
```

##QR con biblioteca qr
```{r}
# Creamos un data frame con todas las variables involucradas en la regresión.
data_ = data.frame(masculino = dtp$masculino, final = dtp$final, esp1 = dtp$esp1, mat1 = dtp$mat1, tiempo = dtp$tiempo)
# Quitamos nulos.
data_ = data_[complete.cases(data_),]
# Creamos la matriz de diseño.
data_model <- model.matrix(~ data_$masculino + data_$final + data_$esp1 + data_$mat1)
y_ = data_$tiempo

# Verificamos los resultados obtenidos con la biblioteca qr de R.
qr_ = qr(data_model)
Q_ = qr.Q(qr_)
R_ = qr.R(qr_)

weights = solve(R_) %*% t(Q_) %*% y_
weights
```

##QR con biblioteca qr y método solve
```{r}
# Creamos un data frame con todas las variables involucradas en la regresión.
data_ = data.frame(masculino = dtp$masculino, final = dtp$final, esp1 = dtp$esp1, mat1 = dtp$mat1, tiempo = dtp$tiempo)
# Quitamos nulos.
data_ = data_[complete.cases(data_),]
# Creamos la matriz de diseño.
data_model <- model.matrix(~ data_$masculino + data_$final + data_$esp1 + data_$mat1)
y_ = data_$tiempo

# Verificamos los resultados obtenidos con la biblioteca qr.solve de R.
weights = qr.solve(a = data_model, b = y_)
weights
```









